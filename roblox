local player = game.Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local filename = "binds.json"

local function saveBinds(keybinds)
    if writefile then
        local data = HttpService:JSONEncode({
            Jump = keybinds.Jump and keybinds.Jump.Name or nil,
            ESP = keybinds.ESP and keybinds.ESP.Name or nil,
            Fly = keybinds.Fly and keybinds.Fly.Name or nil,
        })
        writefile(filename, data)
    end
end

local function loadBinds()
    if readfile and isfile and isfile(filename) then
        local data = readfile(filename)
        local ok, decoded = pcall(function()
            return HttpService:JSONDecode(data)
        end)
        if ok and decoded then
            return {
                Jump = decoded.Jump and Enum.KeyCode[decoded.Jump] or nil,
                ESP = decoded.ESP and Enum.KeyCode[decoded.ESP] or nil,
                Fly = decoded.Fly and Enum.KeyCode[decoded.Fly] or nil,
            }
        end
    end
    return {Jump = nil, ESP = nil, Fly = nil}
end

local jumpBoost = false
local espEnabled = false
local flyEnabled = false
local highlights = {}
local basePartMarkers = {}
local flyConnection
local bodyVelocity
local bodyGyro

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CheatGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game.CoreGui

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 200, 0, 240)
Frame.Position = UDim2.new(0.5, -100, 0.5, -120)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.Active = true
Frame.Draggable = true

local TitleLabel = Instance.new("TextLabel", Frame)
TitleLabel.Size = UDim2.new(1, 0, 0, 25)
TitleLabel.Position = UDim2.new(0, -10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "JANNNMG"
TitleLabel.Font = Enum.Font.SourceSansBold
TitleLabel.TextColor3 = Color3.new(1, 1, 1)
TitleLabel.TextScaled = true
TitleLabel.TextYAlignment = Enum.TextYAlignment.Center

local CloseButton = Instance.new("TextButton", Frame)
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -30, 0, 5)
CloseButton.Text = "X"
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
CloseButton.TextColor3 = Color3.new(1, 1, 1)

local MinimizeButton = Instance.new("TextButton", Frame)
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -60, 0, 5)
MinimizeButton.Text = "–"
MinimizeButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
MinimizeButton.TextColor3 = Color3.new(1, 1, 1)

local JumpButton = Instance.new("TextButton", Frame)
JumpButton.Size = UDim2.new(0, 160, 0, 45)
JumpButton.Position = UDim2.new(0, 20, 0, 35)
JumpButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
JumpButton.TextColor3 = Color3.new(1, 1, 1)

local ESPButton = Instance.new("TextButton", Frame)
ESPButton.Size = UDim2.new(0, 160, 0, 45)
ESPButton.Position = UDim2.new(0, 20, 0, 85)
ESPButton.BackgroundColor3 = Color3.fromRGB(255, 100, 0)
ESPButton.TextColor3 = Color3.new(1, 1, 1)

local FlyButton = Instance.new("TextButton", Frame)
FlyButton.Size = UDim2.new(0, 160, 0, 45)
FlyButton.Position = UDim2.new(0, 20, 0, 135)
FlyButton.BackgroundColor3 = Color3.fromRGB(0, 255, 100)
FlyButton.TextColor3 = Color3.new(1, 1, 1)

local FlySpeedTextBox = Instance.new("TextBox", Frame)
FlySpeedTextBox.Size = UDim2.new(0, 160, 0, 30)
FlySpeedTextBox.Position = UDim2.new(0, 20, 0, 185)
FlySpeedTextBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
FlySpeedTextBox.TextColor3 = Color3.new(1, 1, 1)
FlySpeedTextBox.PlaceholderText = "Fly Speed (0 for default)"
FlySpeedTextBox.Text = ""

local minimized = false
MinimizeButton.MouseButton1Click:Connect(function()
    if minimized then
        Frame.Size = UDim2.new(0, 200, 0, 240)
        JumpButton.Visible = true
        ESPButton.Visible = true
        FlyButton.Visible = true
        FlySpeedTextBox.Visible = true
        minimized = false
    else
        Frame.Size = UDim2.new(0, 200, 0, 30)
        JumpButton.Visible = false
        ESPButton.Visible = false
        FlyButton.Visible = false
        FlySpeedTextBox.Visible = false
        minimized = true
    end
end)

CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
    if flyConnection then
        flyConnection:Disconnect()
    end
    if bodyVelocity then
        bodyVelocity:Destroy()
    end
    if bodyGyro then
        bodyGyro:Destroy()
    end
end)

local function gradualJumpPower(targetPower)
    spawn(function()
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            local currentPower = humanoid.JumpPower
            local step = (targetPower - currentPower) / 10
            for i = 1, 10 do
                if not humanoid then break end
                currentPower = currentPower + step
                humanoid.JumpPower = currentPower
                humanoid.UseJumpPower = true
                wait(0.07 + math.random() * 0.03)
            end
            humanoid.JumpPower = targetPower
            humanoid.UseJumpPower = true
        end
    end)
end

local function toggleJump()
    jumpBoost = not jumpBoost
    if jumpBoost then
        gradualJumpPower(80)
    else
        gradualJumpPower(50)
    end
end

local function createBasePartMarker(part)
    local marker = Instance.new("BillboardGui")
    marker.Adornee = part
    marker.Size = UDim2.new(0, 50, 0, 50)
    marker.AlwaysOnTop = true
    marker.LightInfluence = 0
    local frame = Instance.new("Frame", marker)
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.new(1, 0, 0)
    frame.BorderSizePixel = 0
    frame.BackgroundTransparency = 0.5
    marker.Parent = game.CoreGui
    return marker
end

local function addHighlight(plr)
    if plr == player then return end
    if highlights[plr] then return end
    local character = plr.Character
    if character then
        local highlight = Instance.new("Highlight")
        highlight.Adornee = character
        highlight.FillColor = Color3.new(1, 0, 0)
        highlight.OutlineColor = Color3.new(1, 1, 1)
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = game.CoreGui
        highlights[plr] = highlight
        local basePart = character:FindFirstChild("HumanoidRootPart")
        if basePart then
            local marker = createBasePartMarker(basePart)
            basePartMarkers[plr] = marker
        end
    end
end

local function removeHighlight(plr)
    if highlights[plr] then
        highlights[plr]:Destroy()
        highlights[plr] = nil
    end
    if basePartMarkers[plr] then
        basePartMarkers[plr]:Destroy()
        basePartMarkers[plr] = nil
    end
end

local function updateHighlights()
    while espEnabled do
        local players = game.Players:GetPlayers()
        for i = 1, #players do
            local plr = players[i]
            if plr.Character then
                if not highlights[plr] then
                    addHighlight(plr)
                end
            else
                removeHighlight(plr)
            end
        end
        wait(1 + math.random())
    end
    for plr, _ in pairs(highlights) do
        removeHighlight(plr)
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then
        spawn(updateHighlights)
    else
        for plr, _ in pairs(highlights) do
            removeHighlight(plr)
        end
    end
end

local function toggleFly()
    flyEnabled = not flyEnabled
    local character = player.Character
    if not character then return end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoid or not rootPart then return end

    if flyEnabled then
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = rootPart

        bodyGyro = Instance.new("BodyGyro")
        bodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
        bodyGyro.P = 20000
        bodyGyro.Parent = rootPart

        local moveDirection = Vector3.new(0, 0, 0)

        flyConnection = RunService.RenderStepped:Connect(function()
            local camera = workspace.CurrentCamera
            local moveVector = Vector3.new(0, 0, 0)

            if UserInputService:IsKeyDown(Enum.KeyCode.W) or UserInputService:IsKeyDown(Enum.KeyCode.Up) then
                moveVector = moveVector + camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) or UserInputService:IsKeyDown(Enum.KeyCode.Down) then
                moveVector = moveVector - camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) or UserInputService:IsKeyDown(Enum.KeyCode.Left) then
                moveVector = moveVector - camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) or UserInputService:IsKeyDown(Enum.KeyCode.Right) then
                moveVector = moveVector + camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                moveVector = moveVector + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                moveVector = moveVector - Vector3.new(0, 1, 0)
            end

            -- Динамическое обновление скорости
            local flySpeedInput = tonumber(FlySpeedTextBox.Text)
            local flySpeed = humanoid.WalkSpeed  -- default to game's walk speed
            if flySpeedInput and flySpeedInput > 0 then
                flySpeed = flySpeedInput
            end

            if moveVector.Magnitude > 0 then
                moveDirection = moveVector.Unit * flySpeed
            else
                moveDirection = Vector3.new(0, 0, 0)
            end
            bodyVelocity.Velocity = moveDirection

            -- Поворачиваем персонажа в сторону камеры (горизонтально)
            local flatLookVector = Vector3.new(camera.CFrame.LookVector.X, 0, camera.CFrame.LookVector.Z).Unit
            if flatLookVector.Magnitude > 0 then
                bodyGyro.CFrame = CFrame.new(rootPart.Position, rootPart.Position + flatLookVector)
            end

            humanoid.PlatformStand = true
        end)
    else
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        if bodyVelocity then
            bodyVelocity:Destroy()
            bodyVelocity = nil
        end
        if bodyGyro then
            bodyGyro:Destroy()
            bodyGyro = nil
        end
        humanoid.PlatformStand = false
    end
end

local Keybinds = loadBinds()
local waitingForBind = nil

local function updateButtonText(button, funcName)
    if waitingForBind == button then
        button.Text = "Press key to bind..."
    else
        local state = ""
        if funcName == "Jump" then
            state = jumpBoost and "ON" or "OFF"
        elseif funcName == "ESP" then
            state = espEnabled and "ON" or "OFF"
        elseif funcName == "Fly" then
            state = flyEnabled and "ON" or "OFF"
        end
        local keyName = Keybinds[funcName] and Keybinds[funcName].Name or "Unbound"
        button.Text = funcName .. " " .. state .. " (" .. keyName .. ")"
    end
end

local function updateBind(funcName, keyCode)
    Keybinds[funcName] = keyCode
    saveBinds(Keybinds)
end

updateButtonText(JumpButton, "Jump")
updateButtonText(ESPButton, "ESP")
updateButtonText(FlyButton, "Fly")

local function startBind(button, funcName)
    if waitingForBind then return end
    waitingForBind = button
    updateButtonText(button, funcName)
end

JumpButton.MouseButton2Click:Connect(function() startBind(JumpButton, "Jump") end)
ESPButton.MouseButton2Click:Connect(function() startBind(ESPButton, "ESP") end)
FlyButton.MouseButton2Click:Connect(function() startBind(FlyButton, "Fly") end)

JumpButton.MouseButton1Click:Connect(function()
    if waitingForBind ~= JumpButton then toggleJump() end
    updateButtonText(JumpButton, "Jump")
end)

ESPButton.MouseButton1Click:Connect(function()
    if waitingForBind ~= ESPButton then toggleESP() end
    updateButtonText(ESPButton, "ESP")
end)

FlyButton.MouseButton1Click:Connect(function()
    if waitingForBind ~= FlyButton then toggleFly() end
    updateButtonText(FlyButton, "Fly")
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if waitingForBind then
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if waitingForBind == JumpButton then
                updateBind("Jump", input.KeyCode)
            elseif waitingForBind == ESPButton then
                updateBind("ESP", input.KeyCode)
            elseif waitingForBind == FlyButton then
                updateBind("Fly", input.KeyCode)
            end
            updateButtonText(waitingForBind, waitingForBind == JumpButton and "Jump" or waitingForBind == ESPButton and "ESP" or "Fly")
            waitingForBind = nil
        end
        return
    end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        if Keybinds.Jump and input.KeyCode == Keybinds.Jump then
            toggleJump()
            updateButtonText(JumpButton, "Jump")
        elseif Keybinds.ESP and input.KeyCode == Keybinds.ESP then
            toggleESP()
            updateButtonText(ESPButton, "ESP")
        elseif Keybinds.Fly and input.KeyCode == Keybinds.Fly then
            toggleFly()
            updateButtonText(FlyButton, "Fly")
        end
    end
end)
